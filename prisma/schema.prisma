// ==========================
// GENERATOR & DATASOURCE
// ==========================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================
// ENUMS
// ==========================
enum AgentRole {
  ADMIN
  MEMBER
}

enum PropertyStatus {
  draft
  published
  archived
}

enum BookingStatus {
  pending
  confirmed
  cancelled
}

enum CommissionStatus {
  pending
  paid
}

// ==========================
// AGENCY (ORGANIZATION)
// ==========================
model Agency {
  id      Int     @id @default(autoincrement())
  name    String
  email   String? @unique
  phone   String?
  website String?

  primaryColor   String?
  secondaryColor String?
  logo           String?

  createdAt DateTime @default(now()) @map("created_at")

  locations       String[]
  agents          Agent[]
  properties      Property[]
  salesProperties SalesProperty[]

  @@map("agencies")
}

// ==========================
// AGENT (USER)
// ==========================
model Agent {
  id       Int @id @default(autoincrement())
  agencyId Int @map("agency_id")

  name  String
  email String    @unique
  phone String?
  role  AgentRole @default(MEMBER)

  emailVerified  Boolean   @default(false)
  onboardingStep Int       @default(1)
  lastLoginAt    DateTime?

  createdAt DateTime @default(now()) @map("created_at")

  agency             Agency             @relation(fields: [agencyId], references: [id])
  properties         Property[]         @relation("CreatedByAgent")
  ownedBookings      Booking[]          @relation("OwnerAgent")
  madeBookings       Booking[]          @relation("BookingAgent")
  ownerCommissions   Commission[]       @relation("OwnerCommissions")
  bookingCommissions Commission[]       @relation("BookingCommissions")
  salesProperties    SalesProperty[]
  soldProperties     SalesTransaction[] @relation("SellerAgent")
  boughtProperties   SalesTransaction[] @relation("BuyerAgent")
  sellerCommissions  SalesCommission[]  @relation("SellerCommissions")
  buyerCommissions   SalesCommission[]  @relation("BuyerCommissions")
  amenities          AgentAmenity[]

  @@index([agencyId])
  @@map("agents")
}

// ==========================
// RENTAL PROPERTY
// ==========================
model Property {
  id          Int @id @default(autoincrement())
  agencyId    Int @map("agency_id")
  createdById Int @map("created_by")

  title        String
  description  String?
  location     String
  propertyType String  @map("property_type")
  price        Decimal @db.Decimal(10, 2)
  priceType    String  @default("night") @map("price_type")
  beds         Int
  baths        Int
  sqm          Int

  minimumStayValue Int            @default(0) // numeric value entered
  minimumStayUnit  String         @default("days") // days/weeks/months/years
  classification   String? // Short-Term or Long-Term
  
  amenities        String[]
  nearestTo        String[]
  media            Json
  status           PropertyStatus @default(draft)
  licenseNumber    String?        @map("license_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  agency       Agency                 @relation(fields: [agencyId], references: [id])
  createdBy    Agent                  @relation("CreatedByAgent", fields: [createdById], references: [id])
  bookings     Booking[]
  availability PropertyAvailability[]

  @@index([agencyId])
  @@index([createdById])
  @@map("properties")
}

// ==========================
// BOOKING
// ==========================
model Booking {
  id             Int @id @default(autoincrement())
  propertyId     Int @map("property_id")
  ownerAgentId   Int @map("owner_agent_id")
  bookingAgentId Int @map("booking_agent_id")

  clientName  String
  clientEmail String
  clientPhone String?
  checkIn     DateTime
  checkOut    DateTime
  totalAmount Decimal       @db.Decimal(10, 2)
  status      BookingStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")

  property     Property               @relation(fields: [propertyId], references: [id])
  ownerAgent   Agent                  @relation("OwnerAgent", fields: [ownerAgentId], references: [id])
  bookingAgent Agent                  @relation("BookingAgent", fields: [bookingAgentId], references: [id])
  commission   Commission?
  availability PropertyAvailability[]

  @@index([propertyId])
  @@map("bookings")
}

// ==========================
// COMMISSION (RENTALS)
// ==========================
model Commission {
  id             Int @id @default(autoincrement())
  bookingId      Int @unique @map("booking_id")
  ownerAgentId   Int @map("owner_agent_id")
  bookingAgentId Int @map("booking_agent_id")

  totalAmount       Decimal          @db.Decimal(10, 2)
  ownerCommission   Decimal          @db.Decimal(10, 2)
  bookingCommission Decimal          @db.Decimal(10, 2)
  platformFee       Decimal          @db.Decimal(10, 2)
  commissionRate    Decimal          @default(10.00) @db.Decimal(5, 2)
  status            CommissionStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")

  booking      Booking @relation(fields: [bookingId], references: [id])
  ownerAgent   Agent   @relation("OwnerCommissions", fields: [ownerAgentId], references: [id])
  bookingAgent Agent   @relation("BookingCommissions", fields: [bookingAgentId], references: [id])

  @@map("commissions")
}

// ==========================
// SALES PROPERTY
// ==========================
model SalesProperty {
  id       Int @id @default(autoincrement())
  agencyId Int @map("agency_id")
  agentId  Int @map("agent_id")

  title        String
  description  String?
  location     String
  propertyType String
  price        Decimal        @db.Decimal(12, 2)
  beds         Int
  baths        Int
  sqm          Int
  amenities    String[]
  media        Json
  status       PropertyStatus @default(draft)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency       Agency             @relation(fields: [agencyId], references: [id])
  agent        Agent              @relation(fields: [agentId], references: [id])
  transactions SalesTransaction[]

  @@index([agencyId])
  @@map("sales_properties")
}

// ==========================
// SALES TRANSACTION
// ==========================
model SalesTransaction {
  id            Int @id @default(autoincrement())
  propertyId    Int @map("property_id")
  sellerAgentId Int @map("seller_agent_id")
  buyerAgentId  Int @map("buyer_agent_id")

  buyerName  String
  buyerEmail String
  buyerPhone String?
  salePrice  Decimal       @db.Decimal(12, 2)
  saleDate   DateTime
  status     BookingStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")

  property    SalesProperty    @relation(fields: [propertyId], references: [id])
  sellerAgent Agent            @relation("SellerAgent", fields: [sellerAgentId], references: [id])
  buyerAgent  Agent            @relation("BuyerAgent", fields: [buyerAgentId], references: [id])
  commission  SalesCommission?

  @@map("sales_transactions")
}

// ==========================
// SALES COMMISSION
// ==========================
model SalesCommission {
  id            Int @id @default(autoincrement())
  transactionId Int @unique @map("transaction_id")

  sellerAgentId Int
  buyerAgentId  Int

  totalAmount      Decimal          @db.Decimal(12, 2)
  sellerCommission Decimal          @db.Decimal(12, 2)
  buyerCommission  Decimal          @db.Decimal(12, 2)
  platformFee      Decimal          @db.Decimal(12, 2)
  commissionRate   Decimal          @default(4.00) @db.Decimal(5, 2)
  status           CommissionStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")

  transaction SalesTransaction @relation(fields: [transactionId], references: [id])
  sellerAgent Agent            @relation("SellerCommissions", fields: [sellerAgentId], references: [id])
  buyerAgent  Agent            @relation("BuyerCommissions", fields: [buyerAgentId], references: [id])

  @@map("sales_commissions")
}

// ==========================
// PROPERTY AVAILABILITY
// ==========================
model PropertyAvailability {
  id          Int      @id @default(autoincrement())
  propertyId  Int      @map("property_id")
  startDate   DateTime
  endDate     DateTime
  isAvailable Boolean  @default(true)
  bookingId   Int?
  notes       String?
  createdAt   DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  @@map("property_availability")
}

// ==========================
// AGENT AMENITIES
// ==========================
model AgentAmenity {
  id        Int      @id @default(autoincrement())
  agentId   Int
  name      String
  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id])

  @@map("agent_amenities")
}

// ==========================
// EMAIL OTP
// ==========================
model EmailOtp {
  id        Int      @id @default(autoincrement())
  email     String
  codeHash  String
  type      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
  @@map("email_otps")
}
